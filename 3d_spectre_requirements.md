# 3次元版Spectre立体探索プロジェクト 要件定義書（最終統合版）

**更新日**: 2025年12月3日

## 1. プロジェクトの目標と背景

### 目標
「3次元版Spectre（3D aperiodic monotile）」の形状と、その空間充填パターンの発見、およびその代数的・幾何学的整合性の証明（固有値 $\lambda^2 = 4 + \sqrt{15}$ の整合性検証を含む）。

### 背景
- **2次元Spectre**は、置換行列 $\mathcal{M}$ の最大固有値 $\lambda^2 = 4 + \sqrt{15}$ に基づくア周期性を持つ。この構造は、テンソルネットワークの転送行列の概念と完全に一致し、探索の成功は固有空間の制約に強く依存する。
- **3次元版**は、$\mathbb{Z}^4$ 格子からの射影でなく、おそらく**$\mathbb{Z}^6$ 格子**からの射影（カット＆プロジェクト法）として存在すると推定される。

---

## 2. アプローチの選定
**探索的アプローチ（Edge-matching Growth）の拡張**を採用する。

### 採用の根拠
1.  **アルゴリズムの共通性**: 「隣接探索」のコアロジックは、2Dから3Dへの層状探索に転用可能。
2.  **理論的裏付け（CASPr）**: CASPr理論は、Spectreが「高次元からの射影」であることを示唆。探索で得られた局所パッチが、大域的な**許容領域（Acceptance Domain）**の制約を満たすことで、理論的な正当性が裏付けられる。
3.  **既存成果の統合**: 既存コードは成長率 $\lambda^2 = 4 + \sqrt{15}$ を検証済みであり、この代数情報が探索のフィルタとして機能する。

---

## 3. 実装方針：層状探索（Layered Search）と代数基底の定義
3次元空間を、2次元の層（Layer）を積み重ねるアプローチで解く。

### 3.1. 座標系の代数的定義（物理空間への射影）
タイルの頂点座標 $P$ を、整数係数の線形結合として定義する。これは探索された整数係数 $\mathbf{x}$ を、実際の物理空間 $\mathbb{R}^n$ にマッピングする。

| 項目 | 2次元Spectre (4D整数係数) | 3次元Spectre（拡張：6D整数係数） |
| :--- | :--- | :--- |
| **整数係数ベクトル** | $\mathbf{x} = (a_0, a_1, b_0, b_1) \in \mathbb{Z}^4$ | $\mathbf{u} = (p_0, p_1, q_0, q_1, r_0, r_1) \in \mathbb{Z}^6$ |
| **物理空間座標** | $P = (x, y) \in \mathbb{R}^2$ | $P = (x, y, z) \in \mathbb{R}^3$ |
| **基底ベクトル数** | 4個 ($\mathbf{v}_{a0}, \mathbf{v}_{a1}, \mathbf{v}_{b0}, \mathbf{v}_{b1}$) | 6個 ($\mathbf{u}_{p0}, \mathbf{u}_{p1}, \dots, \mathbf{u}_{r1}$) |

#### A) 2次元版の座標式（現状のコードの基底）
整数係数 $(a_0, a_1, b_0, b_1)$ に対し、物理空間 $P=(x, y)$ は以下で定義される。
$$P = a_0 \mathbf{v}_{a0} + a_1 \mathbf{v}_{a1} + b_0 \mathbf{v}_{b0} + b_1 \mathbf{v}_{b1}$$

ここで、$\mathbf{v}$ は以下の基底ベクトルとする（$c=1/2$, $s=\sqrt{3}/2$）。

```ruby
# ruby形式に置換
V_a0 = Vector[2 * c * scale_A, 0]
V_a1 = Vector[c * scale_A, s * scale_A]
V_b0 = Vector[0, 2 * c * scale_B]
V_b1 = Vector[s * scale_B, c * scale_B]
```

#### B) 3次元版の座標式（拡張基底）
整数係数 $\mathbf{u} = (p_0, p_1, q_0, q_1, r_0, r_1)$ に対し、物理空間 $P=(x, y, z)$ は以下で定義される。これは、$A_3$ 格子（正四面体充填）の3つの主軸方向を120°回転で配置し、Z成分 $\zeta$ を加える設計である。
$$P = p_0 \mathbf{u}_{p0} + p_1 \mathbf{u}_{p1} + q_0 \mathbf{u}_{q0} + q_1 \mathbf{u}_{q1} + r_0 \mathbf{r}_{r0} + r_1 \mathbf{r}_{r1}$$

基底 $\mathbf{u}$ は、$XY$ 平面内の120°回転行列 $R_{120}$ を用いて定義される。

```ruby
# ruby形式に置換 (Scale_A, Scale_B, Scale_C は各ペアのスケール)
# Z成分係数は zeta_A, zeta_A_prime など

# 第1ペア (up_p0, up_p1)
UP_p0 = Vector[2 * c * Scale_A, 0, zeta_A]
UP_p1 = Vector[c * Scale_A, s * Scale_A, zeta_A_prime]

# 第2ペア (uq_q0, uq_q1) - R120を適用
# XY成分は R120 * (2c, 0) や R120 * (c, s) を計算
# Z成分は zeta_B, zeta_B_prime

# 第3ペア (ur_r0, ur_r1) - R120^2を適用
# XY成分は R120^2 * (2c, 0) や R120^2 * (c, s) を計算
# Z成分は zeta_C, zeta_C_prime
```

### 3.2. アルゴリズムの拡張（層間結合のZ制約）
層間隣接ロジック (`find_interlayer_neighbors`) の実装は、高次元格子におけるZ方向の代数的制約を特定することに他ならない。

Layer N の座標 $\mathbf{x}_N$ に、Z軸方向への最小シフト $\mathbf{t}_z$（高次元の辺ベクトル）を加えた $\mathbf{x}_{N+1} = \mathbf{x}_N + \mathbf{t}_z$ が、**3D版の代数的制約（T3）**を満たすかを検証する。これは、元の6個の整数係数の式（2Dの場合）または12個の整数係数の式（3Dの場合）が、$\mathbf{x}$ と $\mathbf{t}_z$ の両方について成立することを意味する。

---

## 4. 段階的詳細化と推進順序

### フェーズ1: 2次元探索の完成と理論的検証（現在）
**目標**: 2次元探索において、偽陽性点をゼロに近づけ、理論的な正当性を確認する（シン・ゴジラ 設定の科学的整合性基準）。

| タスク | 目的 | 現状の課題への対応 |
| :--- | :--- | :--- |
| **T1-1: 厳密な許容領域フィルタの実装（最優先）** | 偽陽性点 (91.82%) を排除し、探索効率を劇的に向上させる。 | PCA/KNN近似の廃止。CASPr理論に基づき、4D射影 $\mathbf{x}_{\perp}$ が、代数的に定義された許容領域 $W$ 内に落ちるかを厳密にチェックする。 |
| **T1-2: 代数的基底の導入** | 垂直空間検証の精度を数値計算から代数計算（MyNumericCoef）に置き換え、誤差をゼロにする。 | $\mathbf{v}$ 基底と、固有値 $\lambda^2$ の代数的関係を実装。 |
| **T1-3: カバレッジの向上戦略** | カバレッジ (20.85%) の低さを解消。 | **置換ルールの活用**: $\mathcal{M}$ を利用し、飛び地的なシードから探索を開始する（探索の代数的誘導）。 |

### フェーズ2: 3次元座標系の定義とマッピング
**目標**: Spectre立体を表現できる3次元座標系（$A_3$格子/FCC）を実装する。

- **T2-1**: 6個の基底ベクトル $\mathbf{u}_{p0}$...$\mathbf{u}_{r1}$ の正確な実数係数（Scaleと $\zeta$）を決定する。
- **T2-2**: 2次元Spectre座標（4次元表現）の、3次元空間（層状配置）へのマッピング定義。

### フェーズ3: 層間隣接ロジックの実装（Z方向制約の特定）
**目標**: Z方向の制約（Layer N $\leftrightarrow$ Layer N+1 の結合条件）を特定する。

- **T3-1**: 2D Spectre図形を「厚みのあるプリズム」または「多面体」として定義し、層間の最小Zシフトベクトル $\mathbf{t}_z$ を代数的に推定する。
- **T3-2**: 層間（Z方向）の代数的整合性チェックの実装。これは、$\mathbf{x}_{N+1} = \mathbf{x}_N + \mathbf{t}_z$ が、3D版の代数的制約を満たすかを検証することに相当する。

### フェーズ4: 3次元探索の実行
**目標**: 実際に3次元空間を充填できるかテストする。

---

## 5. 現状の課題と対策（フェーズ1に集中）

| 課題 | 対策（フェーズ1） |
| :--- | :--- |
| **課題1: 探索結果の偽陽性（適合率の低さ）** | T1-1の厳密な許容領域フィルタの実装。 |
| **課題2: 2次元探索のカバレッジ不足** | T1-3により、置換ルールをシード生成に活用し、探索を代数的に誘導する。 |
| **課題3: 3次元形状の代数的定義の必要性** | T1-2/T2-1で2D/3Dの代数基底を明確に定義し、Z方向制約を特定するための基礎とする。 |
